<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliebus - V3.6 QR Final</title>
    <style>
        :root { 
            --primary: #00b894; --secondary: #0984e3; --warning: #fdcb6e; 
            --danger: #d63031; --purple: #6c5ce7; --dark: #2d3436; 
            --light: #f1f2f6; --success-light: #55efc4;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 0; }
        
        /* Navega√ß√£o */
        .nav-toggle { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; z-index: 100; }
        .nav-toggle a { color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; padding: 6px 15px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); transition: 0.3s; background: rgba(0,0,0,0.1); }
        .nav-toggle a.active { background: white; color: var(--dark); border-color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .app-container { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        
        /* Cabe√ßalhos */
        .gamification-bar { background: var(--dark); color: white; padding: 12px 20px; font-size: 0.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--warning); }
        .level-tag { background: var(--warning); color: var(--dark); padding: 3px 10px; border-radius: 12px; font-weight: 800; font-size: 0.65rem; }
        .header { background: var(--primary); color: white; padding: 50px 20px 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2rem; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header p { margin: 8px 0 0; font-size: 0.9rem; opacity: 0.9; font-weight: 500; }

        /* Bot√µes com Efeito de Eleva√ß√£o e Brilho Validado */
        .btn { border: none; border-radius: 14px; padding: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 1rem; margin-top: 10px; outline: none; display: block; box-sizing: border-box; text-decoration: none; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); filter: brightness(1.1); }

        /* Farol de Lota√ß√£o com Glow Selecionado */
        .farol-container { display: flex; gap: 8px; margin: 15px 0; }
        .btn-lot { border: 3px solid transparent; padding: 15px 5px; font-size: 0.7rem; flex: 1; text-transform: uppercase; border-radius: 10px; cursor: pointer; font-weight: 800; transition: 0.3s; opacity: 0.7; }
        .btn-vazio { background: var(--primary); color: white; }
        .btn-medio { background: var(--warning); color: var(--dark); }
        .btn-lotado { background: var(--danger); color: white; }
        .btn-super { background: var(--purple); color: white; }
        .btn-selected { border-color: #000 !important; transform: scale(1.1) !important; box-shadow: 0 0 20px rgba(0,0,0,0.3) !important; z-index: 5; opacity: 1; }

        /* Estilo do Painel ADM Restaurado */
        .dash-card { margin: 18px; border-radius: 20px; background: #fff; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .dash-card-header { padding: 22px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; background: #e2e8f0; border-top: 1px solid #e2e8f0; }
        .stat-box { background: #fff; padding: 20px 10px; text-align: center; }
        .stat-label { display: block; font-size: 0.65rem; color: #718096; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--dark); }

        .details-area { display: none; background: #f1f5f9; padding: 15px; border-top: 1px solid #e2e8f0; }
        .detail-item { background: white; padding: 18px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .tag-nota { background: #f8fafc; padding: 8px 4px; border-radius: 8px; text-align: center; font-size: 0.7rem; font-weight: bold; border: 1px solid #e2e8f0; }

        .rating-box { background: #f8f9fa; padding: 15px; border-radius: 14px; border: 1px solid #eee; margin-bottom: 12px; }
        .rating-box label { display: block; font-weight: bold; font-size: 0.85rem; color: #444; margin-bottom: 6px; }
        .rating-box select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; background: white; font-size: 1rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .step-container { display: none; padding: 10px; }
        .step-active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #locked-screen { text-align: center; padding: 100px 25px; display: none; }
    </style>
</head>
<body>

    <div class="nav-toggle">
        <a id="nav-user" class="active" onclick="toggleMode('user')">USU√ÅRIO</a>
        <a id="nav-adm" onclick="toggleMode('adm')">ADM</a>
    </div>

    <div class="app-container">
        
        <div id="view-user">
            <div class="gamification-bar">
                <span>üèÜ <span id="user-points">0</span> Pontos</span>
                <span id="user-level-tag" class="level-tag">NOVATO</span>
            </div>

            <div id="locked-screen">
                <div style="font-size: 5rem; margin-bottom: 20px;">üì≤</div>
                <h2>Acesso Bloqueado</h2>
                <p style="color: #666; margin-bottom: 30px;">Para fazer uma nova avalia√ß√£o, escaneie o QR Code no ponto de √¥nibus.</p>
                <button class="btn" style="background: var(--secondary); color: white;" onclick="simulateQR()">ESCANEIE O QR CODE PARA COME√áAR</button>
            </div>

            <div id="user-flow">
                <div class="header">
                    <h1>Avaliebus</h1>
                    <p>Participe e ajude a melhorar a qualidade do transporte p√∫blico</p>
                </div>

                <div id="step1" class="step-container step-active">
                    <div style="text-align: center; padding: 50px 20px;">
                        <div style="font-size: 4.5rem; margin-bottom: 10px;">üìç</div>
                        <h3>Voc√™ est√° no ponto?</h3>
                        <p style="color: #666; margin-bottom: 30px;">Toque no bot√£o para iniciar o cron√¥metro de espera.</p>
                        <button class="btn" style="background: var(--secondary); color:white;" onclick="startWait()">CHEGUEI NO PONTO AGORA</button>
                    </div>
                </div>

                <div id="step2" class="step-container">
                    <div style="text-align: center; padding: 40px 20px;">
                        <p style="font-weight: 600; color: #666;">Tempo de espera decorrido:</p>
                        <div id="timer" style="font-size: 4rem; font-weight: 800; color: var(--secondary); margin: 25px 0; font-family: 'Courier New', monospace;">00:00</div>
                        <button class="btn" style="background: var(--primary); color:white;" onclick="showStep(3)">SUBI NO √îNIBUS AGORA</button>
                    </div>
                </div>

                <div id="step3" class="step-container">
                    <div class="card" style="padding:15px;">
                        <div style="background: #e1f5fe; padding: 18px; border-radius: 15px; text-align: center; font-weight: 800; margin-bottom: 25px; border: 2px solid #b3e5fc; color: #01579b;">
                            ‚è±Ô∏è TEMPO DE ESPERA: <span id="wait-msg-text"></span>
                        </div>

                        <div class="section-title">Identifica√ß√£o</div>
                        <input type="text" id="bus_line" class="btn" style="background:white; border:2px solid #ddd; text-align:center; color:black; box-shadow:none;" placeholder="Qual o n√∫mero da linha?">

                        <div class="section-title">Como est√° a lota√ß√£o?</div>
                        <div class="farol-container">
                            <button class="btn-lot btn-vazio" id="btn-v" onclick="setCrowd('Vazio', 'btn-v')">Vazio</button>
                            <button class="btn-lot btn-medio" id="btn-m" onclick="setCrowd('M√©dio', 'btn-m')">M√©dio</button>
                            <button class="btn-lot btn-lotado" id="btn-l" onclick="setCrowd('Lotado', 'btn-l')">Lotado</button>
                            <button class="btn-lot btn-super" id="btn-s" onclick="setCrowd('Cr√≠tico', 'btn-s')">Cr√≠tico</button>
                        </div>

                        <div class="section-title">D√™ sua nota (1 a 5)</div>
                        <div class="rating-box"><label>Tempo de Espera</label><select id="r_esp"><option value="5">5‚òÖ Excelente</option><option value="3" selected>3‚òÖ Regular</option><option value="1">1‚òÖ P√©ssima</option></select></div>
                        <div class="rating-box"><label>Dire√ß√£o do Motorista</label><select id="r_mot"><option value="5">5‚òÖ Seguro</option><option value="3" selected>3‚òÖ Regular</option><option value="1">1‚òÖ Perigoso</option></select></div>
                        <div class="rating-box"><label>Atendimento do Cobrador</label><select id="r_cob"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="0">Sem Cobrador</option></select></div>
                        
                        <div class="grid-2">
                            <div class="rating-box"><label>Limpeza Interna</label><select id="r_lim"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                            <div class="rating-box"><label>Estado dos Bancos</label><select id="r_bnc"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                        </div>

                        <div class="section-title">Ocorr√™ncias</div>
                        <div style="background:#fff5f5; padding: 18px; border-radius:15px; border:1px solid #ffe3e3;">
                            <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="c_t"> Evas√£o (Porta Tr√°s)</label>
                            <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="c_a"> Ass√©dio / Inseguran√ßa</label>
                            <label style="display:block;"><input type="checkbox" id="c_d"> Dire√ß√£o Perigosa</label>
                        </div>

                        <button class="btn" style="background:var(--success-light); margin-top:30px; color: var(--dark);" onclick="finishSurvey()">ENVIAR AVALIA√á√ÉO AGORA</button>
                    </div>
                </div>

                <div id="step4" class="step-container" style="text-align: center; padding: 120px 20px;">
                    <div style="font-size: 6rem;">‚úÖ</div>
                    <h2 style="color: var(--primary);">Avalia√ß√£o Enviada!</h2>
                    <p>Sua voz ajuda a melhorar o transporte.</p>
                </div>
            </div>
        </div>

        <div id="view-adm" style="display:none;">
            <div class="header" style="background:var(--secondary);">
                <h1>Painel Administrativo</h1>
                <p>M√©tricas de Qualidade em Tempo Real</p>
            </div>
            <div id="dashboard-content"></div>
            <div style="padding: 30px; text-align: center;">
                <button class="btn" style="background:var(--danger); color:white; width: auto; padding: 15px 40px; border-radius: 50px;" onclick="clearDatabase()">üóëÔ∏è LIMPAR BANCO DE DADOS</button>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('avaliebus_db')) || [];
        let profile = JSON.parse(localStorage.getItem('avaliebus_profile')) || { points:0, lastEval:null, id:'ID-'+Math.floor(Math.random()*999) };
        let busData = { format: '', lot: '', lat: null, lng: null };
        let startTime, timerInterval;

        window.onload = function() { checkQR(); updateUI(); };

        function checkQR() {
            const params = new URLSearchParams(window.location.search);
            // Verifica se o usu√°rio j√° avaliou hoje E se n√£o veio pelo QR code da URL do seu projeto
            if (profile.lastEval === new Date().toLocaleDateString() && params.get('qr') !== 'true') {
                document.getElementById('user-flow').style.display = 'none';
                document.getElementById('locked-screen').style.display = 'block';
            }
        }

        function simulateQR() {
            // Simula o redirecionamento que o QR code f√≠sico faria para a sua URL do GitHub
            window.location.href = "https://bno229-max.github.io/avaliebus/?qr=true";
        }

        function updateUI() {
            document.getElementById('user-points').innerText = profile.points;
            document.getElementById('user-level-tag').innerText = profile.points >= 50 ? "FISCAL PRATA ü•à" : "NOVATO";
        }

        function toggleMode(m) {
            document.getElementById('view-user').style.display = m === 'user' ? 'block' : 'none';
            document.getElementById('view-adm').style.display = m === 'adm' ? 'block' : 'none';
            if(m === 'adm') renderDashboard();
        }

        function startWait() {
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => { busData.lat = p.coords.latitude; busData.lng = p.coords.longitude; }); }
            startTime = new Date(); showStep(2);
            timerInterval = setInterval(() => {
                let diff = Math.floor((new Date() - startTime) / 1000);
                document.getElementById('timer').innerText = Math.floor(diff/60).toString().padStart(2,'0')+":"+(diff%60).toString().padStart(2,'0');
                busData.format = `${Math.floor(diff/60)}m e ${diff%60}s`;
            }, 1000);
        }

        function setCrowd(val, id) {
            busData.lot = val;
            document.querySelectorAll('.btn-lot').forEach(b => b.classList.remove('btn-selected'));
            document.getElementById(id).classList.add('btn-selected');
        }

        function showStep(n) {
            if(n === 3) { clearInterval(timerInterval); document.getElementById('wait-msg-text').innerText = busData.format; }
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('step-active'));
            document.getElementById('step'+n).classList.add('step-active');
            window.scrollTo(0,0);
        }

        function finishSurvey() {
            const linha = document.getElementById('bus_line').value;
            if(!linha || !busData.lot) return alert("Preencha a linha e a lota√ß√£o!");

            db.push({
                linha: linha.toUpperCase(), espera_txt: busData.format, lot: busData.lot,
                user_id: profile.id, data: new Date().toLocaleDateString(), 
                hora: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                notas: {
                    esp: parseInt(document.getElementById('r_esp').value),
                    mot: parseInt(document.getElementById('r_mot').value),
                    cob: parseInt(document.getElementById('r_cob').value),
                    lim: parseInt(document.getElementById('r_lim').value),
                    bnc: parseInt(document.getElementById('r_bnc').value)
                },
                ocorr: [
                    document.getElementById('c_t').checked ? "Porta Tr√°s" : null,
                    document.getElementById('c_a').checked ? "Ass√©dio" : null,
                    document.getElementById('c_d').checked ? "Dire√ß√£o" : null
                ].filter(x => x),
                gps: busData.lat ? `https://www.google.com/maps?q=${busData.lat},${busData.lng}` : null
            });

            profile.points += 10; profile.lastEval = new Date().toLocaleDateString();
            localStorage.setItem('avaliebus_db', JSON.stringify(db));
            localStorage.setItem('avaliebus_profile', JSON.stringify(profile));
            showStep(4);
            setTimeout(() => { window.location.search = ""; }, 2500);
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = "";
            const linhas = {};

            db.forEach(av => {
                if(!linhas[av.linha]) linhas[av.linha] = { t:0, sEsp:0, sMot:0, sCob:0, sLim:0, sBnc:0, itens:[] };
                const l = linhas[av.linha];
                l.t++;
                l.sEsp += av.notas.esp; l.sMot += av.notas.mot; l.sCob += av.notas.cob; l.sLim += av.notas.lim; l.sBnc += av.notas.bnc;
                l.itens.push(av);
            });

            for(let l in linhas) {
                const i = linhas[l];
                const card = document.createElement('div');
                card.className = 'dash-card';
                card.innerHTML = `
                    <div class="dash-card-header" onclick="toggleCard(this)">
                        <strong>LINHA ${l}</strong>
                        <span style="font-weight:800; color:var(--secondary); font-size:0.8rem;">${i.t} ENVIOS ‚ñº</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-label">ESPERA</span><span class="stat-value">${(i.sEsp/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">MOTORISTA</span><span class="stat-value">${(i.sMot/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">COBRADOR</span><span class="stat-value">${(i.sCob/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">LIMPEZA</span><span class="stat-value">${(i.sLim/i.t).toFixed(1)}</span></div>
                        <div class="stat-box" style="grid-column: span 2;"><span class="stat-label">CONSERVA√á√ÉO / BANCOS</span><span class="stat-value">${(i.sBnc/i.t).toFixed(1)}</span></div>
                    </div>
                    <div class="details-area">
                        ${i.itens.slice().reverse().map(av => `
                            <div class="detail-item">
                                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#666; margin-bottom:8px;">
                                    <span>üë§ ${av.user_id}</span><span>üìÖ ${av.data} - ${av.hora}</span>
                                </div>
                                <div><b>Lota√ß√£o:</b> ${av.lot} | <b>Espera:</b> ${av.espera_txt}</div>
                                <div class="grid-2" style="margin-top:10px;">
                                    <div class="tag-nota">Esp: ${av.notas.esp}‚òÖ</div>
                                    <div class="tag-nota">Mot: ${av.notas.mot}‚òÖ</div>
                                </div>
                                ${av.ocorr.length > 0 ? `<div style="color:var(--danger); font-size:0.75rem; font-weight:800; margin-top:10px;">‚ö†Ô∏è OCORR√äNCIAS: ${av.ocorr.join(', ')}</div>` : ''}
                                ${av.gps ? `<a href="${av.gps}" target="_blank" style="color:var(--secondary); display:block; margin-top:10px; font-size:0.7rem;">üìç VER LOCALIZA√á√ÉO NO MAPA</a>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function toggleCard(el) {
            const det = el.parentElement.querySelector('.details-area');
            det.style.display = det.style.display === 'block' ? 'none' : 'block';
        }

        function clearDatabase() {
            if(confirm("Deseja apagar todos os dados permanentemente?")) {
                db = []; localStorage.removeItem('avaliebus_db'); renderDashboard();
            }
        }
    </script>
</body>
</html>