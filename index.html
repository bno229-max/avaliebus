<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliebus - V3.5 Final Consolidada</title>
    <style>
        :root { 
            --primary: #00b894; --secondary: #0984e3; --warning: #fdcb6e; 
            --danger: #d63031; --purple: #6c5ce7; --dark: #2d3436; 
            --light: #f1f2f6; --success-light: #55efc4;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 0; }
        
        .nav-toggle { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; z-index: 100; }
        .nav-toggle a { color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; padding: 4px 12px; border-radius: 15px; font-size: 0.65rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); transition: 0.3s; background: rgba(0,0,0,0.1); }
        .nav-toggle a.active { background: white; color: var(--dark); border-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .app-container { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        
        .gamification-bar { background: var(--dark); color: white; padding: 10px 20px; font-size: 0.75rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--warning); }
        .level-tag { background: var(--warning); color: var(--dark); padding: 2px 8px; border-radius: 10px; font-weight: 800; font-size: 0.65rem; }

        .header { background: var(--primary); color: white; padding: 45px 20px 25px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        .header p { margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9; }

        .card { margin: 15px; padding: 20px; border-radius: 15px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        .btn { border: none; border-radius: 12px; padding: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 1rem; margin-top: 10px; outline: none; display: block; box-sizing: border-box; text-decoration: none; text-align: center; }
        .btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); filter: brightness(1.1); }

        .farol-container { display: flex; gap: 6px; margin-bottom: 10px; }
        .btn-lot { border: 3px solid transparent; padding: 12px 2px; font-size: 0.65rem; flex: 1; text-transform: uppercase; border-radius: 8px; cursor: pointer; font-weight: 800; transition: 0.3s; }
        .btn-vazio { background: var(--primary); color: white; }
        .btn-medio { background: var(--warning); color: var(--dark); }
        .btn-lotado { background: var(--danger); color: white; }
        .btn-super { background: var(--purple); color: white; }
        .btn-selected { border-color: #000 !important; transform: scale(1.1) !important; box-shadow: 0 0 20px rgba(0,0,0,0.3) !important; z-index: 5; }

        .section-title { color: var(--secondary); border-left: 5px solid var(--secondary); padding-left: 12px; margin: 25px 0 10px 0; font-size: 0.95rem; font-weight: 800; text-transform: uppercase; }
        .rating-box { background: #f8f9fa; padding: 12px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; }
        .rating-box label { display: block; font-weight: bold; font-size: 0.8rem; color: #555; margin-bottom: 5px; }
        .rating-box select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background: white; cursor: pointer; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .dash-card { margin: 15px; border-radius: 16px; background: #fff; border: 1px solid #edf2f7; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .dash-card-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; background: #edf2f7; border-top: 1px solid #edf2f7; }
        .stat-box { background: #fff; padding: 12px; text-align: center; border-bottom: 1px solid #f1f2f6; }
        .stat-label { display: block; font-size: 0.55rem; color: #718096; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; }
        .stat-value { font-size: 1rem; font-weight: 700; color: var(--dark); }

        .details-area { display: none; background: #f8fafc; padding: 10px; border-top: 1px solid #edf2f7; }
        .detail-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; font-size: 0.8rem; }
        
        .step-container { display: none; padding: 10px; }
        .step-active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #locked-screen { text-align: center; padding: 80px 20px; display: none; }
    </style>
</head>
<body>

    <div class="nav-toggle">
        <a id="nav-user" class="active" onclick="toggleMode('user')">USU√ÅRIO</a>
        <a id="nav-adm" onclick="toggleMode('adm')">ADM</a>
    </div>

    <div class="app-container">
        
        <div id="view-user">
            <div class="gamification-bar">
                <span>üèÜ <span id="user-points">0</span> Pontos</span>
                <span id="user-level-tag" class="level-tag">NOVATO</span>
            </div>

            <div id="locked-screen">
                <div style="font-size: 5rem; margin-bottom: 20px;">üì≤</div>
                <h2>Acesso Bloqueado</h2>
                <p style="color: #666;">Para fazer uma nova avalia√ß√£o, escaneie o QR Code no ponto de √¥nibus.</p>
            </div>

            <div id="user-flow">
                <div class="header">
                    <h1>Avaliebus</h1>
                    <p>Participe e ajude a melhorar a qualidade do transporte p√∫blico</p>
                </div>

                <div id="step1" class="step-container step-active">
                    <div style="text-align: center; padding: 40px 10px;">
                        <div style="font-size: 4rem;">üìç</div>
                        <h3>Voc√™ est√° no ponto?</h3>
                        <p style="color: #666; margin-bottom: 20px;">Toque no bot√£o para iniciar o cron√¥metro de espera.</p>
                        <button class="btn" style="background: var(--secondary); color:white;" onclick="startWait()">CHEGUEI AGORA</button>
                    </div>
                </div>

                <div id="step2" class="step-container">
                    <div style="text-align: center; padding: 20px;">
                        <p>Tempo de espera atual:</p>
                        <div id="timer" style="font-size: 3.5rem; font-weight: 800; color: var(--secondary); margin: 20px 0; font-family: monospace;">00:00</div>
                        <button class="btn" style="background: var(--primary); color:white;" onclick="showStep(3)">SUBI NO √îNIBUS</button>
                    </div>
                </div>

                <div id="step3" class="step-container">
                    <div class="card">
                        <div style="background: #e1f5fe; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid #b3e5fc;">
                            ‚è±Ô∏è Espera total: <span id="wait-msg-text"></span>
                        </div>

                        <div class="section-title">Identifica√ß√£o</div>
                        <input type="text" id="bus_line" class="btn" style="background:white; border:2px solid #ddd; text-align:center; color:black; cursor:text;" placeholder="N√∫mero da Linha">

                        <div class="section-title">Lota√ß√£o Atual</div>
                        <div class="farol-container">
                            <button class="btn-lot btn-vazio" id="btn-v" onclick="setCrowd('Vazio', 'btn-v')">Vazio</button>
                            <button class="btn-lot btn-medio" id="btn-m" onclick="setCrowd('M√©dio', 'btn-m')">M√©dio</button>
                            <button class="btn-lot btn-lotado" id="btn-l" onclick="setCrowd('Lotado', 'btn-l')">Lotado</button>
                            <button class="btn-lot btn-super" id="btn-s" onclick="setCrowd('Imposs√≠vel', 'btn-s')">Imposs√≠vel</button>
                        </div>

                        <div class="section-title">Notas de Qualidade</div>
                        <div class="rating-box"><label>Tempo de Espera</label><select id="r_esp"><option value="5">5‚òÖ Excelente</option><option value="4">4‚òÖ Boa</option><option value="3" selected>3‚òÖ Regular</option><option value="1">1‚òÖ P√©ssima</option></select></div>
                        <div class="rating-box"><label>Motorista</label><select id="r_mot"><option value="5">5‚òÖ</option><option value="4">4‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                        <div class="rating-box"><label>Cobrador</label><select id="r_cob"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="0">N√£o possui</option></select></div>
                        
                        <div class="grid-2">
                            <div class="rating-box"><label>Limpeza</label><select id="r_lim"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                            <div class="rating-box"><label>Conserva√ß√£o/Bancos</label><select id="r_bnc"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                        </div>

                        <div class="section-title">Ocorr√™ncias</div>
                        <div style="background:#fff5f5; padding: 15px; border-radius:12px; border:1px solid #ffe3e3;">
                            <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="c_t"> Evas√£o (Porta Tr√°s)</label>
                            <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="c_a"> Ass√©dio / Seguran√ßa</label>
                            <label style="display:block;"><input type="checkbox" id="c_d"> Dire√ß√£o Perigosa</label>
                        </div>

                        <div class="section-title">Coment√°rio Adicional</div>
                        <textarea id="user_obs" class="btn" style="background:white; border:2px solid #ddd; text-align:left; height:80px; font-size:0.9rem; cursor:text;" placeholder="Opcional..."></textarea>

                        <button class="btn" style="background:var(--success-light); margin-top:20px;" onclick="finishSurvey()">ENVIAR AVALIA√á√ÉO</button>
                    </div>
                </div>

                <div id="step4" class="step-container" style="text-align: center; padding: 100px 20px;">
                    <div style="font-size: 5rem;">‚úÖ</div>
                    <h2>Obrigado!</h2>
                    <p>Sua voz ajuda a melhorar o transporte!</p>
                </div>
            </div>
        </div>

        <div id="view-adm" style="display:none;">
            <div class="header" style="background:var(--secondary);">
                <h1>Painel Administrativo</h1>
                <p>M√©tricas Consolidadas por Linha</p>
            </div>
            <div id="dashboard-content"></div>
            <div style="padding: 20px; text-align: center;">
                <button class="btn" style="background:var(--danger); color:white;" onclick="clearDatabase()">LIMPAR BANCO DE DADOS</button>
            </div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('avaliebus_db')) || [];
        let profile = JSON.parse(localStorage.getItem('avaliebus_profile')) || { points:0, lastEval:null, id:'ID-'+Math.floor(Math.random()*999) };
        let busData = { format: '', lot: '', lat: null, lng: null };
        let startTime, timerInterval;

        window.onload = function() { checkQR(); updateUI(); };

        function checkQR() {
            const params = new URLSearchParams(window.location.search);
            if (profile.lastEval === new Date().toLocaleDateString() && params.get('qr') !== 'true') {
                document.getElementById('user-flow').style.display = 'none';
                document.getElementById('locked-screen').style.display = 'block';
            }
        }

        function updateUI() {
            document.getElementById('user-points').innerText = profile.points;
            document.getElementById('user-level-tag').innerText = profile.points >= 50 ? "COLABORADOR PRATA" : "NOVATO";
        }

        function toggleMode(m) {
            document.getElementById('view-user').style.display = m === 'user' ? 'block' : 'none';
            document.getElementById('view-adm').style.display = m === 'adm' ? 'block' : 'none';
            if(m === 'adm') renderDashboard();
        }

        function startWait() {
            if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(p => { busData.lat = p.coords.latitude; busData.lng = p.coords.longitude; }); }
            startTime = new Date(); showStep(2);
            timerInterval = setInterval(() => {
                let diff = Math.floor((new Date() - startTime) / 1000);
                document.getElementById('timer').innerText = Math.floor(diff/60).toString().padStart(2,'0')+":"+(diff%60).toString().padStart(2,'0');
                busData.format = `${Math.floor(diff/60)}m e ${diff%60}s`;
            }, 1000);
        }

        function setCrowd(val, id) {
            busData.lot = val;
            document.querySelectorAll('.btn-lot').forEach(b => b.classList.remove('btn-selected'));
            document.getElementById(id).classList.add('btn-selected');
        }

        function showStep(n) {
            if(n === 3) { clearInterval(timerInterval); document.getElementById('wait-msg-text').innerText = busData.format; }
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('step-active'));
            document.getElementById('step'+n).classList.add('step-active');
        }

        function finishSurvey() {
            const linha = document.getElementById('bus_line').value;
            if(!linha || !busData.lot) return alert("Preencha a linha e a lota√ß√£o!");

            db.push({
                linha: linha.toUpperCase(), espera_txt: busData.format, lot: busData.lot,
                user_id: profile.id, obs: document.getElementById('user_obs').value,
                data: new Date().toLocaleDateString(), hora: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                notas: {
                    esp: parseInt(document.getElementById('r_esp').value),
                    mot: parseInt(document.getElementById('r_mot').value),
                    cob: parseInt(document.getElementById('r_cob').value),
                    lim: parseInt(document.getElementById('r_lim').value),
                    bnc: parseInt(document.getElementById('r_bnc').value)
                },
                gps: busData.lat ? `https://www.google.com/maps?q=${busData.lat},${busData.lng}` : null
            });

            profile.points += 10; profile.lastEval = new Date().toLocaleDateString();
            localStorage.setItem('avaliebus_db', JSON.stringify(db));
            localStorage.setItem('avaliebus_profile', JSON.stringify(profile));
            showStep(4);
            setTimeout(() => { window.location.search = ""; }, 3000);
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = "";
            const linhas = {};

            db.forEach(av => {
                if(!linhas[av.linha]) linhas[av.linha] = { t:0, sEsp:0, sMot:0, sCob:0, sLim:0, sBnc:0, itens:[] };
                const l = linhas[av.linha];
                l.t++;
                l.sEsp += av.notas.esp; l.sMot += av.notas.mot; l.sCob += av.notas.cob; l.sLim += av.notas.lim; l.sBnc += av.notas.bnc;
                l.itens.push(av);
            });

            for(let l in linhas) {
                const i = linhas[l];
                const card = document.createElement('div');
                card.className = 'dash-card';
                card.innerHTML = `
                    <div class="dash-card-header" onclick="toggleCard(this)">
                        <strong>LINHA ${l}</strong>
                        <span style="font-size:0.75rem;">${i.t} envios ‚ñº</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-label">Espera</span><span class="stat-value">${(i.sEsp/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">Motorista</span><span class="stat-value">${(i.sMot/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">Cobrador</span><span class="stat-value">${(i.sCob/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">Limpeza</span><span class="stat-value">${(i.sLim/i.t).toFixed(1)}</span></div>
                        <div class="stat-box" style="grid-column: span 2;"><span class="stat-label">Conserva√ß√£o/Bancos</span><span class="stat-value">${(i.sBnc/i.t).toFixed(1)}</span></div>
                    </div>
                    <div class="details-area">
                        ${i.itens.slice().reverse().map(av => `
                            <div class="detail-item">
                                <div style="display:flex; justify-content:space-between; color:#718096; font-size:0.65rem; margin-bottom:5px;">
                                    <span>üë§ ${av.user_id}</span><span>üìÖ ${av.data} - ${av.hora}</span>
                                </div>
                                <b>Lota√ß√£o:</b> ${av.lot} | <b>Tempo:</b> ${av.espera_txt}<br>
                                ${av.obs ? `<div style="background:#f8fafc; padding:8px; margin:8px 0; border-radius:8px;">üí¨ ${av.obs}</div>` : ''}
                                ${av.gps ? `<a href="${av.gps}" target="_blank" style="color:var(--secondary); font-size:0.7rem; font-weight:800; text-decoration:none;">üìç VER LOCALIZA√á√ÉO NO MAPA</a>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function toggleCard(el) {
            const det = el.parentElement.querySelector('.details-area');
            det.style.display = det.style.display === 'block' ? 'none' : 'block';
        }

        function clearDatabase() {
            if(confirm("Deseja apagar todas as avalia√ß√µes?")) {
                db = []; localStorage.removeItem('avaliebus_db'); renderDashboard();
            }
        }
    </script>
</body>
</html>