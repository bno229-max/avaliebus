<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliebus - Vers√£o Final Validada + GPS</title>
    <style>
        :root { 
            --primary: #00b894; --secondary: #0984e3; --warning: #fdcb6e; 
            --danger: #d63031; --purple: #6c5ce7; --dark: #2d3436; 
            --light: #f1f2f6; --success-light: #55efc4;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 0; }
        
        /* Navega√ß√£o Superior */
        .nav-toggle { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; z-index: 100; }
        .nav-toggle a { color: rgba(255,255,255,0.7); text-decoration: none; cursor: pointer; padding: 4px 12px; border-radius: 15px; font-size: 0.65rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); transition: 0.3s; background: rgba(0,0,0,0.1); }
        .nav-toggle a.active { background: white; color: var(--dark); border-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .app-container { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        
        .header { background: var(--primary); color: white; padding: 45px 20px 25px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        .header p { margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9; }
        
        .card { margin: 15px; padding: 20px; border-radius: 15px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        /* Bot√µes com Efeitos Validados */
        .btn { border: none; border-radius: 12px; padding: 18px; font-weight: bold; cursor: pointer; width: 100%; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 1rem; margin-top: 10px; outline: none; display: block; box-sizing: border-box; }
        .btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); filter: brightness(1.1); }

        /* Farol de Lota√ß√£o com Glow */
        .farol-container { display: flex; gap: 6px; margin-bottom: 10px; }
        .btn-lot { border: 3px solid transparent; padding: 12px 2px; font-size: 0.65rem; flex: 1; text-transform: uppercase; border-radius: 8px; cursor: pointer; font-weight: 800; transition: all 0.3s ease; }
        .btn-lot:hover { transform: scale(1.08); }
        .btn-vazio { background: var(--primary); color: white; }
        .btn-medio { background: var(--warning); color: var(--dark); }
        .btn-lotado { background: var(--danger); color: white; }
        .btn-super { background: var(--purple); color: white; }
        .btn-selected { border-color: #000 !important; transform: scale(1.1) !important; box-shadow: 0 0 20px rgba(0,0,0,0.3) !important; z-index: 2; }

        /* Se√ß√µes e Alinhamento */
        .section-title { color: var(--secondary); border-left: 5px solid var(--secondary); padding-left: 12px; margin: 25px 0 10px 0; font-size: 0.95rem; font-weight: 800; text-transform: uppercase; }
        .rating-box { background: #f8f9fa; padding: 12px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 10px; box-sizing: border-box; }
        .rating-box label { display: block; font-weight: bold; font-size: 0.8rem; color: #555; margin-bottom: 5px; }
        .rating-box select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9rem; background: white; cursor: pointer; }
        
        .check-group { background:#fff5f5; padding: 15px; border-radius: 12px; border: 1px solid #ffe3e3; }
        .check-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.85rem; cursor: pointer; }

        /* ADM */
        .header-adm { background: var(--secondary) !important; }
        .dash-card { margin: 15px; border-radius: 16px; background: #fff; border: 1px solid #edf2f7; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        .dash-card-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #fff; }
        .dropdown-arrow { transition: transform 0.3s; color: #cbd5e0; }
        .expanded .dropdown-arrow { transform: rotate(180deg); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: #edf2f7; border-top: 1px solid #edf2f7; }
        .stat-box { background: #fff; padding: 12px; text-align: center; }
        .stat-label { display: block; font-size: 0.6rem; color: #718096; font-weight: 800; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--dark); }

        /* Detalhes Individuais (Restaurado Completo) */
        .details-area { display: none; background: #f8fafc; padding: 10px; border-top: 1px solid #edf2f7; }
        .detail-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; font-size: 0.8rem; }
        .detail-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; color: #718096; font-size: 0.7rem; }
        .detail-notes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 8px; }
        .tag-nota { background: #f1f2f6; padding: 4px; border-radius: 4px; text-align: center; font-size: 0.65rem; font-weight: bold; border: 1px solid #eee; }
        .tag-ocorr { color: var(--danger); font-weight: bold; margin-top: 8px; display: block; font-size: 0.75rem; border-top: 1px dashed #feb2b2; padding-top: 5px; }
        .map-btn { display: inline-block; margin-top: 10px; color: var(--secondary); text-decoration: none; font-weight: 800; font-size: 0.7rem; border: 1px solid var(--secondary); padding: 5px 10px; border-radius: 6px; transition: 0.3s; }
        .map-btn:hover { background: var(--secondary); color: white; }

        .step-container { display: none; padding: 10px; }
        .step-active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="nav-toggle">
        <a id="nav-user" class="active" onclick="toggleMode('user')">USU√ÅRIO</a>
        <a id="nav-adm" onclick="toggleMode('adm')">ADM</a>
    </div>

    <div class="app-container">
        
        <div id="view-user">
            <div class="header">
                <h1>Avaliebus</h1>
                <p>Participe e ajude a melhorar a qualidade do transporte p√∫blico</p>
            </div>

            <div id="step1" class="step-container step-active">
                <div class="card" style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">üìç</div>
                    <h3>Chegou no ponto agora?</h3>
                    <p style="color: #666; font-size: 0.9rem;">Toque no bot√£o abaixo para iniciarmos a medi√ß√£o da sua espera.</p>
                    <button class="btn" style="background: var(--secondary); color:white;" onclick="startWait()">CHEGUEI NO PONTO AGORA</button>
                </div>
            </div>

            <div id="step2" class="step-container">
                <div class="card" style="text-align: center;">
                    <h3 style="color: #666;">Tempo de espera:</h3>
                    <div id="timer" style="font-size: 3.5rem; font-weight: 800; color: var(--secondary); margin: 20px 0; font-family: monospace;">00:00</div>
                    <button class="btn" style="background: var(--primary); color:white;" onclick="showStep(3)">SUBI NO √îNIBUS</button>
                </div>
            </div>

            <div id="step3" class="step-container">
                <div class="card">
                    <div style="background: #e1f5fe; color:#01579b; margin-bottom:20px; padding: 15px; border-radius: 12px; font-weight: bold; text-align: center; border: 1px solid #b3e5fc;">
                        ‚è±Ô∏è <span id="wait-msg-text"></span>
                    </div>

                    <div class="section-title">Identifica√ß√£o</div>
                    <input type="text" id="bus_line" class="btn" style="background:white; border:2px solid #ddd; text-align:center; color:black; cursor:text;" placeholder="N√∫mero da Linha">

                    <div class="section-title">Farol de Lota√ß√£o</div>
                    <div class="farol-container">
                        <button class="btn-lot btn-vazio" id="btn-v" onclick="setCrowd('Vazio', 'btn-v')">Vazio</button>
                        <button class="btn-lot btn-medio" id="btn-m" onclick="setCrowd('M√©dio', 'btn-m')">M√©dio</button>
                        <button class="btn-lot btn-lotado" id="btn-l" onclick="setCrowd('Lotado', 'btn-l')">Lotado</button>
                        <button class="btn-lot btn-super" id="btn-s" onclick="setCrowd('Imposs√≠vel', 'btn-s')">Imposs√≠vel</button>
                    </div>

                    <div class="section-title">Notas de Qualidade</div>
                    <div class="rating-box">
                        <label>Nota do Tempo de Espera</label>
                        <select id="r_esp"><option value="5">5‚òÖ Muito R√°pido</option><option value="4">4‚òÖ Bom</option><option value="3" selected>3‚òÖ Regular</option><option value="2">2‚òÖ Ruim</option><option value="1">1‚òÖ P√©ssimo</option></select>
                    </div>
                    <div class="rating-box">
                        <label>Motorista (Educa√ß√£o/Condu√ß√£o)</label>
                        <select id="r_mot"><option value="5">5‚òÖ</option><option value="4">4‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="2">2‚òÖ</option><option value="1">1‚òÖ</option></select>
                    </div>
                    <div class="rating-box">
                        <label>Cobrador (Educa√ß√£o/Atendimento)</label>
                        <select id="r_cob"><option value="5">5‚òÖ</option><option value="4">4‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="2">2‚òÖ</option><option value="1">1‚òÖ</option><option value="0">N√£o tem</option></select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="rating-box"><label>Limpeza</label><select id="r_lim"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                        <div class="rating-box"><label>Bancos</label><select id="r_bnc"><option value="5">5‚òÖ</option><option value="3" selected>3‚òÖ</option><option value="1">1‚òÖ</option></select></div>
                    </div>

                    <div class="section-title">Presenciou algo do tipo hoje?</div>
                    <div class="check-group">
                        <label class="check-item"><input type="checkbox" id="c_v"> ü•ñ Vendedores Ambulantes</label>
                        <label class="check-item"><input type="checkbox" id="c_t"> üö™ Entraram pela porta de tr√°s</label>
                        <label class="check-item"><input type="checkbox" id="c_a"> ‚ö†Ô∏è Ass√©dio</label>
                        <label class="check-item"><input type="checkbox" id="c_r"> ‚ö†Ô∏è Assalto / Roubo</label>
                        <label class="check-item"><input type="checkbox" id="c_i"> Desrespeito a Idosos / PCD</label>
                        <label class="check-item"><input type="checkbox" id="c_b"> Brigas ou Confus√µes</label>
                        <label class="check-item"><input type="checkbox" id="c_d"> Dire√ß√£o Perigosa</label>
                    </div>

                    <input type="text" id="user_name" class="btn" style="background:white; border:2px solid #ddd; text-align:center; color:black; cursor:text; margin-top:20px;" placeholder="Seu Nome (Opcional)">
                    <button class="btn" style="background:var(--success-light); color:var(--dark);" onclick="finishSurvey()">ENVIAR AVALIA√á√ÉO</button>
                </div>
            </div>

            <div id="step4" class="step-container" style="text-align: center; padding: 100px 20px;">
                <div style="font-size: 5rem;">‚úÖ</div>
                <h2>Avalia√ß√£o Enviada!</h2>
                <p>Obrigado por colaborar.<br>Reiniciando...</p>
            </div>
        </div>

        <div id="view-adm" style="display:none;">
            <div class="header header-adm">
                <h1>Painel ADM</h1>
                <p>Relat√≥rios Detalhados por Linha</p>
            </div>
            <div id="dashboard-content"></div>
            <div style="text-align: center; padding: 20px;"><button onclick="clearDatabase()" style="background:#eee; border:none; padding:10px; border-radius:5px; font-size:0.6rem; cursor:pointer;">LIMPAR BANCO</button></div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('avaliebus_db')) || [];
        let startTime, waitInterval;
        let busData = { format: '', lot: '', lat: null, lng: null };

        function toggleMode(m) {
            document.getElementById('view-user').style.display = m === 'user' ? 'block' : 'none';
            document.getElementById('view-adm').style.display = m === 'adm' ? 'block' : 'none';
            document.getElementById('nav-user').className = m === 'user' ? 'active' : '';
            document.getElementById('nav-adm').className = m === 'adm' ? 'active' : '';
            if(m === 'adm') renderDashboard();
        }

        function startWait() {
            // Captura Localiza√ß√£o Silenciosa ao clicar
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    busData.lat = pos.coords.latitude;
                    busData.lng = pos.coords.longitude;
                });
            }
            
            startTime = new Date(); showStep(2); 
            waitInterval = setInterval(() => {
                let d = Math.floor((new Date() - startTime) / 1000);
                document.getElementById('timer').innerText = Math.floor(d/60).toString().padStart(2,'0')+":"+(d%60).toString().padStart(2,'0');
                busData.format = `${Math.floor(d/60)}min e ${d%60}s`;
            }, 1000); 
        }

        function setCrowd(v, id) {
            busData.lot = v;
            document.querySelectorAll('.btn-lot').forEach(b => b.classList.remove('btn-selected'));
            document.getElementById(id).classList.add('btn-selected');
        }

        function showStep(n) {
            if(n === 3) { clearInterval(waitInterval); document.getElementById('wait-msg-text').innerText = `Voc√™ esperou exatamente ${busData.format} por este √¥nibus.`; }
            document.querySelectorAll('.step-container').forEach(s => s.classList.remove('step-active'));
            document.getElementById('step'+n).classList.add('step-active');
            window.scrollTo(0,0);
        }

        function finishSurvey() {
            const linha = document.getElementById('bus_line').value;
            if(!linha || !busData.lot) { alert("Informe Linha e Lota√ß√£o!"); return; }
            db.push({
                linha: linha.toUpperCase(), espera_txt: busData.format, lot: busData.lot,
                lat: busData.lat, lng: busData.lng,
                nome: document.getElementById('user_name').value || "An√¥nimo",
                data: new Date().toLocaleDateString(), hora: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                notas: {
                    esp: parseInt(document.getElementById('r_esp').value),
                    mot: parseInt(document.getElementById('r_mot').value),
                    cob: parseInt(document.getElementById('r_cob').value),
                    lim: parseInt(document.getElementById('r_lim').value),
                    bnc: parseInt(document.getElementById('r_bnc').value)
                },
                ocorr: [
                    document.getElementById('c_v').checked ? "Ambulantes" : null,
                    document.getElementById('c_t').checked ? "Porta Tr√°s" : null,
                    document.getElementById('c_a').checked ? "Ass√©dio" : null,
                    document.getElementById('c_r').checked ? "Assalto" : null,
                    document.getElementById('c_i').checked ? "PCD/Idosos" : null,
                    document.getElementById('c_b').checked ? "Briga" : null,
                    document.getElementById('c_d').checked ? "Perigo" : null
                ].filter(x => x)
            });
            localStorage.setItem('avaliebus_db', JSON.stringify(db));
            showStep(4);
            setTimeout(() => { location.reload(); }, 3000);
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = "";
            if(db.length === 0) { container.innerHTML = "<p style='text-align:center; padding:30px;'>Sem dados.</p>"; return; }

            const linhas = {};
            db.forEach(av => {
                if(!linhas[av.linha]) linhas[av.linha] = { t:0, sE:0, sM:0, sC:0, cC:0, sL:0, sB:0, itens:[] };
                const l = linhas[av.linha];
                l.t++; l.sE += av.notas.esp; l.sM += av.notas.mot; l.sL += av.notas.lim; l.sB += av.notas.bnc;
                if(av.notas.cob > 0) { l.sC += av.notas.cob; l.cC++; }
                l.itens.push(av);
            });

            for(let l in linhas) {
                const i = linhas[l];
                const card = document.createElement('div');
                card.className = 'dash-card';
                card.innerHTML = `
                    <div class="dash-card-header" onclick="toggleCard(this)">
                        <strong>LINHA ${l}</strong>
                        <div><span style="font-size:0.6rem; color:#999; margin-right:10px;">${i.t} envios</span><span class="dropdown-arrow">‚ñº</span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-label">‚è±Ô∏è ESPERA</span><span class="stat-value">${(i.sE/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">üë®‚Äç‚úàÔ∏è MOTO</span><span class="stat-value">${(i.sM/i.t).toFixed(1)}</span></div>
                        <div class="stat-box"><span class="stat-label">üéüÔ∏è COB</span><span class="stat-value">${i.cC > 0 ? (i.sC/i.cC).toFixed(1) : 'N/A'}</span></div>
                        <div class="stat-box"><span class="stat-label">üßπ LIMP</span><span class="stat-value">${(i.sL/i.t).toFixed(1)}</span></div>
                    </div>
                    <div class="details-area">
                        ${i.itens.slice().reverse().map(av => `
                            <div class="detail-item">
                                <div class="detail-header">
                                    <span>üë§ ${av.nome}</span>
                                    <span>üìÖ ${av.data} √†s ${av.hora}</span>
                                </div>
                                <div><b>‚è±Ô∏è Espera:</b> ${av.espera_txt} | <b>üë• Lota√ß√£o:</b> ${av.lot}</div>
                                <div class="detail-notes-grid">
                                    <div class="tag-nota">Esp: ${av.notas.esp}‚òÖ</div>
                                    <div class="tag-nota">Mot: ${av.notas.mot}‚òÖ</div>
                                    <div class="tag-nota">Cob: ${av.notas.cob > 0 ? av.notas.cob + '‚òÖ' : 'N/A'}</div>
                                    <div class="tag-nota">Lim: ${av.notas.lim}‚òÖ</div>
                                    <div class="tag-nota">Banc: ${av.notas.bnc}‚òÖ</div>
                                </div>
                                ${av.ocorr.length > 0 ? `<span class="tag-ocorr">‚ö†Ô∏è ${av.ocorr.join(', ')}</span>` : ''}
                                ${av.lat ? `<a href="https://www.google.com/maps?q=${av.lat},${av.lng}" target="_blank" class="map-btn">üìç VER NO MAPA</a>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            }
        }

        function toggleCard(el) {
            const card = el.parentElement;
            const details = card.querySelector('.details-area');
            card.classList.toggle('expanded');
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
        }

        function clearDatabase() { if(confirm("Apagar tudo?")) { db = []; localStorage.removeItem('avaliebus_db'); renderDashboard(); } }
    </script>
</body>
</html>